{% extends "base.html" %}

{% block title %}Mood Logger - MoodSync{% endblock %}

{% block content %}
<style>
    /* Responsive adjustments for mood logger */
    .video-container {
        position: relative;
        overflow: hidden;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    @media (max-width: 768px) {
        .card-body {
            padding: 1rem;
        }
        
        .btn-lg {
            padding: 0.5rem 1rem;
            font-size: 1rem;
        }
        
        .alert {
            padding: 0.75rem;
        }
        
        .alert ol {
            padding-left: 1.5rem;
        }
    }
    
    @media (max-width: 576px) {
        .video-container {
            margin: -0.5rem -0.5rem 1rem -0.5rem;
            border-radius: 0;
        }
        
        .card-header {
            padding: 0.75rem 1rem;
        }
        
        h5.card-title {
            font-size: 1.1rem;
        }
        
        .form-control-lg {
            font-size: 1rem;
            padding: 0.375rem 0.75rem;
        }
    }
</style>
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient-primary-to-secondary">
                    <h5 class="card-title text-white mb-0">Capture Your Mood</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-lg-6 col-md-12">
                            <div class="video-container mb-3">
                                <video id="video" width="100%" height="auto" autoplay muted playsinline class="rounded"></video>
                                <canvas id="canvas" style="display: none;"></canvas>
                                <div id="emotion-result" class="mt-3 text-center"></div>
                                <div id="loading-indicator" class="text-center" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p>Analyzing your expression...</p>
                                </div>
                            </div>
                            <div class="d-grid gap-2">
                                <button id="capture-btn" class="btn btn-primary btn-lg">
                                    <i class="bi bi-camera"></i> Capture Mood
                                </button>
                                <button id="retry-btn" class="btn btn-outline-secondary" style="display: none;">
                                    <i class="bi bi-arrow-repeat"></i> Try Again
                                </button>
                            </div>
                            <div class="alert alert-info mt-3">
                                <i class="bi bi-info-circle-fill me-2"></i> Make sure your face is clearly visible and well-lit for accurate emotion detection.
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-12 mt-4 mt-lg-0">
                            <div id="mood-form" style="display: none;" class="p-2 p-md-0">
                                <h5 class="mb-3">How are you feeling?</h5>
                                <div class="mb-3">
                                    <label for="detected-emotion" class="form-label">Detected Emotion</label>
                                    <input type="text" class="form-control form-control-lg" id="detected-emotion" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="intensity" class="form-label">Intensity (1-10)</label>
                                    <input type="range" class="form-range" min="1" max="10" id="intensity" value="5">
                                    <div class="d-flex justify-content-between">
                                        <small>Mild</small>
                                        <small id="intensity-value" class="badge bg-primary">5</small>
                                        <small>Intense</small>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="notes" class="form-label">Notes (Optional)</label>
                                    <textarea class="form-control" id="notes" rows="3" placeholder="What triggered this emotion?"></textarea>
                                </div>
                                <div class="d-grid gap-2">
                                    <button id="save-btn" class="btn btn-success btn-lg">
                                        <i class="bi bi-check-circle"></i> Save Entry
                                    </button>
                                    <a href="/mood_log" class="btn btn-outline-primary">
                                        <i class="bi bi-journal-text"></i> View Mood Log
                                    </a>
                                </div>
                            </div>
                            <div id="initial-instructions" class="p-2 p-md-0">
                                <div class="alert alert-info">
                                    <h5 class="d-flex align-items-center"><i class="bi bi-info-circle me-2"></i> How it works</h5>
                                    <ol class="ps-3 mb-2">
                                        <li class="mb-1">Click "Capture Mood" when you're ready</li>
                                        <li class="mb-1">Our AI will analyze your facial expression</li>
                                        <li class="mb-1">Adjust the detected emotion if needed</li>
                                        <li class="mb-1">Add notes about what triggered your mood</li>
                                        <li class="mb-1">Save your entry to track your emotional patterns</li>
                                    </ol>
                                </div>
                                <div class="alert alert-warning">
                                    <p class="mb-0"><i class="bi bi-lightbulb me-2"></i> <strong>Tip:</strong> For best results, ensure good lighting and face the camera directly.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card shadow-sm d-none d-md-block">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Debug Panel</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleDebugPanel()">
                        <i class="bi bi-gear"></i> Toggle
                    </button>
                </div>
                <div class="card-body">
                    <div id="debug-content" style="display: none; height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                        <div class="debug-log"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
class MoodLogger {
    constructor() {
        this.video = document.getElementById('video');
        this.canvas = document.getElementById('canvas');
        this.captureBtn = document.getElementById('capture-btn');
        this.retryBtn = document.getElementById('retry-btn');
        this.saveBtn = document.getElementById('save-btn');
        this.emotionResult = document.getElementById('emotion-result');
        this.loadingIndicator = document.getElementById('loading-indicator');
        this.moodForm = document.getElementById('mood-form');
        this.initialInstructions = document.getElementById('initial-instructions');
        this.detectedEmotionInput = document.getElementById('detected-emotion');
        this.intensityInput = document.getElementById('intensity');
        this.intensityValue = document.getElementById('intensity-value');
        this.notesInput = document.getElementById('notes');
        
        this.stream = null;
        this.capturedImage = null;
        this.detectedEmotion = null;
        
        this.initCamera();
        this.setupEventListeners();
        this.log('MoodLogger initialized');
    }
    
    async initCamera() {
        try {
            this.log('Initializing camera...');
            // First check if mediaDevices is supported
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('Your browser does not support camera access. Please try a different browser.');
            }
            
            // List available devices to debug
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            this.log('Available video devices:', 'info', videoDevices);
            
            if (videoDevices.length === 0) {
                throw new Error('No camera detected on your device.');
            }
            
            const constraints = {
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'user'
                },
                audio: false
            };
            
            this.stream = await navigator.mediaDevices.getUserMedia(constraints);
            this.video.srcObject = this.stream;
            // Apply horizontal flip to video element to correct mirroring
            this.video.style.transform = 'scaleX(-1)';
            this.log('Camera initialized successfully');
            
            // Wait for video to be ready
            this.video.onloadedmetadata = () => {
                this.log('Video metadata loaded');
                this.video.play()
                    .then(() => this.log('Video playback started'))
                    .catch(err => {
                        this.log('Video playback failed: ' + err.message, 'error');
                        this.handleCameraError(err);
                    });
            };
            
            // Add error handler for video element
            this.video.onerror = (err) => {
                this.log('Video element error: ' + err, 'error');
                this.handleCameraError(err);
            };
        } catch (error) {
            this.log('Error initializing camera: ' + error.message, 'error');
            this.handleCameraError(error);
        }
    }
    
    handleCameraError(error) {
        let errorMessage = 'Camera access denied or not available.';
        
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            errorMessage = 'Camera access denied. Please allow camera access and refresh the page.';
        } else if (error.name === 'NotFoundError') {
            errorMessage = 'No camera found on your device.';
        } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
            errorMessage = 'Camera is already in use by another application.';
        } else if (error.name === 'OverconstrainedError') {
            errorMessage = 'Camera does not meet the required constraints.';
        }
        
        this.emotionResult.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> ${errorMessage}
                <button class="btn btn-sm btn-outline-danger mt-2" onclick="window.location.reload()">Refresh Page</button>
            </div>
        `;
    }
    
    setupEventListeners() {
        this.captureBtn.addEventListener('click', () => this.captureMood());
        this.retryBtn.addEventListener('click', () => this.retry());
        this.saveBtn.addEventListener('click', () => this.saveMoodEntry());
        this.intensityInput.addEventListener('input', () => {
            this.intensityValue.textContent = this.intensityInput.value;
        });
    }
    
    captureMood() {
        this.log('Capturing mood...');
        this.captureBtn.style.display = 'none';
        this.loadingIndicator.style.display = 'block';
        
        // Draw video frame to canvas
        const context = this.canvas.getContext('2d');
        this.canvas.width = this.video.videoWidth;
        this.canvas.height = this.video.videoHeight;
        context.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
        
        // Convert canvas to base64 image
        this.capturedImage = this.canvas.toDataURL('image/jpeg');
        
        // Send to emotion detection API
        this.detectEmotion(this.capturedImage);
    }
    
    async detectEmotion(imageData) {
        this.log('Detecting emotion from image data...');
        this.loadingIndicator.style.display = 'block';
        
        try {
            // Use the correct endpoint that matches our backend
            // Using the correct API endpoint from the backend
            const response = await fetch('/api/detect-emotion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken() // Add CSRF token for Django
                },
                body: JSON.stringify({
                    image: imageData
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                this.log('API error response:', 'error', errorText);
                throw new Error(`Server error (${response.status}): ${errorText || 'Unknown error'}`);
            }
            
            const result = await response.json();
            this.log('Emotion detection result:', 'info', result);
            
            if (result.error) {
                throw new Error(result.error);
            }
            
            // Check if emotion is present in the result
            if (!result.emotion) {
                throw new Error('No emotion detected in the image. Please try again with a clearer facial expression.');
            }
            
            this.handleDetectionResult(result);
        } catch (error) {
            this.log('Error detecting emotion: ' + error.message, 'error');
            this.emotionResult.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> ${error.message}
                </div>
            `;
            this.loadingIndicator.style.display = 'none';
            this.retryBtn.style.display = 'block';
        }
    }
    
    // Get CSRF token from cookies for Django
    getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        this.log('CSRF Token:', 'info', cookieValue ? 'Found' : 'Not found');
        return cookieValue;
    }
    
    handleDetectionResult(result) {
        this.loadingIndicator.style.display = 'none';
        this.retryBtn.style.display = 'block';
        this.initialInstructions.style.display = 'none';
        this.moodForm.style.display = 'block';
        
        // Display detected emotion
        this.detectedEmotion = result.emotion;
        this.detectedEmotionInput.value = this.detectedEmotion;
        
        // Show emotion result with appropriate color
        const emotionColors = {
            'happy': '#28a745',
            'sad': '#6c757d',
            'angry': '#dc3545',
            'surprised': '#ffc107',
            'neutral': '#17a2b8',
            'fear': '#6610f2',
            'disgust': '#20c997'
        };
        
        const color = emotionColors[this.detectedEmotion.toLowerCase()] || '#6c757d';
        
        this.emotionResult.innerHTML = `
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h4 style="color: ${color}">${this.detectedEmotion}</h4>
                    <p class="mb-0">Detected emotion</p>
                </div>
            </div>
        `;
    }
    
    retry() {
        this.log('Retrying mood capture...');
        this.captureBtn.style.display = 'block';
        this.retryBtn.style.display = 'none';
        this.emotionResult.innerHTML = '';
        this.moodForm.style.display = 'none';
        this.initialInstructions.style.display = 'block';
        this.capturedImage = null;
        this.detectedEmotion = null;
    }
    
    async saveMoodEntry() {
        try {
            this.log('Saving mood entry...');
            
            // Validate form data
            if (!this.detectedEmotionInput.value) {
                throw new Error('No emotion detected. Please capture your mood first.');
            }
            
            const moodData = {
                emotion: this.detectedEmotionInput.value,
                intensity: parseInt(this.intensityInput.value) || 5,
                notes: this.notesInput.value,
                image: this.capturedImage, // Include the captured image
                timestamp: new Date().toISOString()
            };
            
            this.log('Submitting mood data', 'info', {
                emotion: moodData.emotion,
                intensity: moodData.intensity,
                notes: moodData.notes ? 'Provided' : 'Not provided',
                image: moodData.image ? 'Included' : 'Not included'
            });
            
            // Using the correct endpoint for saving mood
            const response = await fetch('/save_mood', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken() // Add CSRF token for Django
                },
                body: JSON.stringify(moodData)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                this.log('API error response:', 'error', errorText);
                throw new Error(`Server error (${response.status}): ${errorText || 'Unknown error'}`);
            }
            
            const result = await response.json();
            this.log('Mood entry saved successfully', 'success', result);
            
            // Show success message
            this.emotionResult.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> Mood entry saved successfully!
                </div>
            `;
            
            // Disable save button to prevent double submission
            this.saveBtn.disabled = true;
            
            // Reset form after a short delay
            setTimeout(() => {
                this.retry();
                this.saveBtn.disabled = false;
            }, 2000);
            
            return true;
        } catch (error) {
            this.log('Error saving mood entry: ' + error.message, 'error');
            this.emotionResult.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> Error saving mood entry: ${error.message}
                </div>
            `;
            return false;
        }
    }
    
    log(message, level = 'info', data = null) {
        const timestamp = new Date().toLocaleTimeString();
        const logMessage = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
        console.log(logMessage, data || '');
        
        // Add to debug panel
        const debugContent = document.querySelector('#debug-content');
        if (debugContent) {
            const logElement = document.createElement('div');
            logElement.className = `log-${level}`;
            logElement.style.borderBottom = '1px solid #eee';
            logElement.style.padding = '2px 0';
            
            if (level === 'error') {
                logElement.style.color = '#dc3545';
            } else if (level === 'success') {
                logElement.style.color = '#28a745';
            }
            
            logElement.textContent = logMessage;
            
            if (data) {
                const dataElement = document.createElement('pre');
                dataElement.style.fontSize = '0.7rem';
                dataElement.style.margin = '2px 0 5px 10px';
                dataElement.style.padding = '5px';
                dataElement.style.background = '#f1f1f1';
                dataElement.style.borderRadius = '3px';
                dataElement.textContent = JSON.stringify(data, null, 2);
                logElement.appendChild(dataElement);
            }
            
            debugContent.appendChild(logElement);
            
            // Auto-scroll to bottom
            debugContent.scrollTop = debugContent.scrollHeight;
        }
    }
}

// Initialize the logger when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM loaded, initializing MoodLogger...');
    const moodLogger = new MoodLogger();
    
    // Make it globally available for debugging
    window.moodLogger = moodLogger;
});

// Toggle debug panel visibility
function toggleDebugPanel() {
    const debugContent = document.getElementById('debug-content');
    if (debugContent.style.display === 'block') {
        debugContent.style.display = 'none';
    } else {
        debugContent.style.display = 'block';
    }
}

// Debug function to check camera permissions
async function checkCameraPermissions() {
    try {
        const permissions = await navigator.permissions.query({ name: 'camera' });
        console.log('Camera permission status:', permissions.state);
        return permissions.state;
    } catch (error) {
        console.log('Could not check camera permissions:', error);
        return 'unknown';
    }
}

// Debug function to list available media devices
async function listMediaDevices() {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        console.log('Available video devices:', videoDevices);
        return videoDevices;
    } catch (error) {
        console.error('Error listing media devices:', error);
        return [];
    }
}

// Make debug functions available globally
window.checkCameraPermissions = checkCameraPermissions;
window.listMediaDevices = listMediaDevices;
</script>
{% endblock %}